{{range services}}
{{$service:=.Name}}
{{range $tag, $services := service $service | byTag}}
{{if service "python-app"}}
upstream {{$service}} {
  {{range $services}} server {{.Address}}:{{.Port}} max_fails=2 fail_timeout=3s;
  {{end}}
}

server {
  listen 80;

  location / {
    proxy_pass          http://{{$service}};
    include             /etc/nginx/proxy_params;
    proxy_http_version  1.1;
    proxy_set_header    Connection "";
  }
}{{end}}{{end}}
{{end}}
